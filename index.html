<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì²­ì¶˜ ê½ƒë°­ - ìš°ë¦¬ë“¤ì˜ ì²« ì•±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Firebase SDK ì„í¬íŠ¸ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, addDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ì‚¬ì¥ë‹˜ì´ ì§ì ‘ ê°€ì ¸ì˜¤ì‹  íŒŒì´ì–´ë² ì´ìŠ¤ ì—´ì‡  ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyDBoIKG_1uKmpoEoEL9Og60lQAdQU5Rij8",
            authDomain: "my-flower-garden-854d3.firebaseapp.com",
            projectId: "my-flower-garden-854d3",
            storageBucket: "my-flower-garden-854d3.firebasestorage.app",
            messagingSenderId: "959879973342",
            appId: "1:959879973342:web:76c1df7ca11d4b7316354f",
            measurementId: "G-JTR9F40G1Z"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // ê¹ƒí—ˆë¸Œ ë°°í¬ë¥¼ ìœ„í•œ ì•± ID ì„¤ì •
        const appId = 'flower-garden-v20';

        // ì „ì—­ ë³€ìˆ˜ ë…¸ì¶œ (ë‹¤ë¥¸ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•˜ê²Œ í•¨)
        window.db = db;
        window.auth = auth;
        window.appId = appId;
        window.firebaseUtils = { collection, doc, addDoc, updateDoc, onSnapshot, query, serverTimestamp };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@700;800&display=swap');
        
        body {
            font-family: 'Nanum Gothic', sans-serif;
            background: #F3F4ED;
            user-select: none;
            overflow: hidden;
            color: #2D3748;
        }

        #garden-display {
            background: linear-gradient(to bottom, #A5D6A7 0%, #81C784 100%);
            border-radius: 0 0 40px 40px;
            position: relative;
            overflow: hidden;
            height: 280px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .planted-flower {
            position: absolute;
            bottom: 20px;
            transition: all 0.5s ease-out;
            animation: sway 3s infinite ease-in-out;
            transform-origin: bottom center;
        }

        @keyframes sway {
            0%, 100% { transform: rotate(-3deg); }
            50% { transform: rotate(3deg); }
        }

        .flower-card {
            width: 100%;
            max-width: 120px;
            aspect-ratio: 1 / 1.1;
            perspective: 1000px;
            margin: 0 auto;
        }

        .card-inner {
            width: 100%; height: 100%;
            background: white; border-radius: 20px;
            display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem; box-shadow: 0 6px 0 #E2E8F0;
            border: 4px solid #F7FAFC;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .card-inner span { visibility: hidden; }
        .card-inner.selected span, .card-inner.matched span { visibility: visible; }
        .card-inner.selected { background: #FFF9C4; border-color: #F6E05E; transform: scale(1.05); }
        .card-inner.matched { animation: match-out 0.6s forwards; }

        @keyframes match-out {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); filter: brightness(1.2); }
            100% { transform: scale(0); opacity: 0; }
        }

        .btn-main {
            background: linear-gradient(180deg, #FF6B6B 0%, #EE5253 100%);
            box-shadow: 0 8px 0 #C0392B; border-radius: 35px; transition: all 0.1s;
        }
        .btn-main:active { transform: translateY(6px); box-shadow: 0 4px 0 #C0392B; }

        .btn-sub {
            background: linear-gradient(180deg, #48BB78 0%, #38A169 100%);
            box-shadow: 0 6px 0 #276749; border-radius: 25px; transition: all 0.1s;
        }
        .btn-sub:active { transform: translateY(4px); box-shadow: 0 2px 0 #276749; }

        .modal {
            display: none; position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85); align-items: center; justify-content: center;
            z-index: 200; backdrop-filter: blur(8px);
        }

        .log-item, .community-item {
            background: white; border-left: 8px solid #48BB78;
            border-radius: 15px; padding: 15px; margin-bottom: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.03);
        }

        .community-item { border-left-color: #F6AD55; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- í™ˆ í™”ë©´ -->
    <div id="home-screen" class="flex-1 flex flex-col overflow-y-auto">
        <div id="capture-area" class="bg-[#FDFBF0]">
            <div id="garden-display">
                <div class="absolute top-6 left-8 text-white">
                    <h1 class="text-4xl font-black drop-shadow-lg">ì²­ì¶˜ ê½ƒë°­</h1>
                    <p class="text-lg font-bold opacity-90">ë‚˜ì˜ ì˜ˆìœ ì •ì›</p>
                </div>
                <div id="medal-icon" class="absolute top-6 right-8 text-5xl"></div>
                <div id="flower-bed" class="w-full h-full flex items-end justify-center px-6"></div>
            </div>

            <div class="p-8 text-center">
                <div class="inline-block bg-white px-6 py-2 rounded-full border-2 border-green-100 mb-6 shadow-sm">
                    <p class="text-green-800 font-bold text-xl">ëˆ„ì  ì ìˆ˜: <span id="total-collected">0</span>ì </p>
                </div>
                
                <div class="grid grid-cols-2 gap-4 w-full max-w-sm mx-auto">
                    <button onclick="startGame()" class="btn-main text-white text-3xl font-black py-6 px-4 col-span-2 mb-2">
                        ì‹œì‘í•˜ê¸° ğŸŒ¸
                    </button>
                    <button onclick="showCommunity()" class="btn-sub text-white text-lg font-black py-4 px-2 bg-orange-400">
                        ìš°ë¦¬ ë™ë„¤ ì†Œì‹
                    </button>
                    <button onclick="showLogs()" class="btn-sub text-white text-lg font-black py-4 px-2 bg-blue-500">
                        ì„±ì¥ ì¼ì§€
                    </button>
                    <button onclick="saveGardenImage()" class="btn-sub text-white text-lg font-black py-4 px-2 bg-purple-500 col-span-2">
                        ì •ì› ì‚¬ì§„ ì €ì¥í•˜ê¸° ğŸ“¸
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ìš°ë¦¬ ë™ë„¤ ì†Œì‹ í™”ë©´ -->
    <div id="community-screen" class="hidden flex-1 flex flex-col bg-[#FDFBF0]">
        <div class="top-bar flex items-center p-4 bg-white border-b shadow-sm">
            <button onclick="goHome()" class="text-lg bg-gray-100 py-2 px-4 rounded-xl font-bold mr-4">â—€ í™ˆìœ¼ë¡œ</button>
            <h2 class="text-2xl font-black text-orange-600">ìš°ë¦¬ ë™ë„¤ ê½ƒë°­ ì†Œì‹</h2>
        </div>
        <div class="flex-1 overflow-y-auto p-6" id="community-container">
            <p class="text-center mt-20 text-gray-400 font-bold">ì†Œì‹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
    </div>

    <!-- ì„±ì¥ ì¼ì§€ í™”ë©´ -->
    <div id="logs-screen" class="hidden flex-1 flex flex-col bg-[#FDFBF0]">
        <div class="top-bar flex items-center p-4">
            <button onclick="goHome()" class="text-lg bg-gray-100 py-2 px-4 rounded-xl font-bold mr-4">â—€ ë’¤ë¡œ</button>
            <h2 class="text-2xl font-black text-blue-800">ë‚˜ì˜ ì„±ì¥ ì¼ì§€</h2>
        </div>
        <div class="flex-1 overflow-y-auto p-6" id="logs-container"></div>
    </div>

    <!-- ì¼ê¸° ì“°ê¸° ëª¨ë‹¬ -->
    <div id="diary-modal" class="modal">
        <div class="bg-white rounded-[40px] p-8 m-6 max-w-sm w-full text-center">
            <h2 class="text-2xl font-black text-blue-700 mb-4">ì˜¤ëŠ˜ ê¸°ë¶„ì€ ì–´ë– ì‹ ê°€ìš”?</h2>
            <textarea id="diary-input" class="w-full border-2 border-blue-100 rounded-2xl p-4 text-xl mb-6 focus:outline-none" rows="3" placeholder="ì˜ˆ: ì˜¤ëŠ˜ ì°¸ ì¦ê±°ìš´ ë‚ ì´ì—ˆë‹¤!"></textarea>
            <div class="flex flex-col gap-3">
                <button onclick="saveDiary(true)" class="btn-main text-white text-2xl font-bold py-4 px-10 w-full">ë™ë„¤ì— ìë‘í•˜ê³  ê¸°ë¡</button>
                <button onclick="saveDiary(false)" class="bg-blue-500 text-white text-xl font-bold py-3 px-10 rounded-3xl w-full">ë‚˜ë§Œ ë³´ê¸°ë¡œ ê¸°ë¡</button>
                <button onclick="closeModal('diary-modal')" class="text-lg text-gray-400 font-bold underline mt-2">ì•ˆ ì“¸ë˜ìš”</button>
            </div>
        </div>
    </div>

    <!-- ê²Œì„ í™”ë©´ -->
    <div id="game-screen" class="hidden flex-1 flex flex-col bg-white">
        <div class="top-bar flex justify-between items-center p-4 border-b">
            <button onclick="goHome()" class="text-lg bg-gray-100 py-2 px-4 rounded-xl font-bold">â—€ ê·¸ë§Œ</button>
            <div class="text-2xl font-black text-green-700" id="stage-display">1ë‹¨ê³„</div>
            <div></div>
        </div>
        <div class="flex-1 flex flex-col justify-center items-center p-4 overflow-hidden">
            <div id="game-grid" class="grid gap-3 justify-center content-center h-full max-h-[70vh]"></div>
        </div>
    </div>

    <div id="result-modal" class="modal">
        <div class="bg-white rounded-[40px] p-8 m-6 max-w-sm w-full text-center shadow-2xl">
            <h2 class="text-3xl font-black text-green-700 mb-4">ì°¸ ì˜í•˜ì…¨ì–´ìš”!</h2>
            <p class="text-xl text-gray-700 font-bold mb-6">ì˜¤ëŠ˜ì˜ ì¶”ì–µì„ ê¸°ë¡í•´ë³´ì„¸ìš”.</p>
            <button onclick="openDiaryModal()" class="btn-main text-white text-2xl font-bold py-6 px-10 rounded-3xl w-full mb-4">ì˜¤ëŠ˜ì˜ í•œ ì¤„ ê¸°ë¡</button>
            <button onclick="nextStage()" class="text-xl text-green-600 font-bold mb-4 block w-full">ê¸°ë¡ ì—†ì´ ê³„ì†í•˜ê¸°</button>
        </div>
    </div>

    <script type="module">
        import { signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { doc, collection, addDoc, updateDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const flowerDb = [
            { icon: 'ğŸŒ¸', name: 'ë²šê½ƒ' }, { icon: 'ğŸŒ»', name: 'í•´ë°”ë¼ê¸°' },
            { icon: 'ğŸŒ·', name: 'íŠ¤ë¦½' }, { icon: 'ğŸŒ¹', name: 'ì¥ë¯¸' },
            { icon: 'ğŸŒº', name: 'ë¬´ê¶í™”' }, { icon: 'ğŸŒ¼', name: 'ë°ì´ì§€' },
            { icon: 'ğŸ€', name: 'í´ë¡œë²„' }, { icon: 'ğŸŒ¿', name: 'ìƒˆì‹¹' }
        ];

        let currentStage = 1;
        let totalScore = 0;
        let selectedCards = [];
        let matchedCount = 0;
        let totalCardsInStage = 0;
        let diaries = [];
        let currentUser = null;
        let communityUnsubscribe = null;

        const init = async () => {
            const auth = window.auth;
            if (!auth) return;

            try {
                // íŒŒì´ì–´ë² ì´ìŠ¤ ìµëª… ë¡œê·¸ì¸ ì‹œì‘
                await signInAnonymously(auth);
            } catch (err) {
                console.error("ì¸ì¦ ì‹¤íŒ¨:", err);
            }

            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                if (user) {
                    loadLocalData();
                    window.updateUI();
                    window.updateGarden();
                    startCommunityListener();
                }
            });
        };

        function loadLocalData() {
            totalScore = parseInt(localStorage.getItem('totalScore') || 0);
            diaries = JSON.parse(localStorage.getItem('diaries') || "[]");
        }

        window.updateUI = () => {
            document.getElementById('total-collected').innerText = totalScore.toLocaleString();
            const medal = document.getElementById('medal-icon');
            if (totalScore >= 3000) medal.innerText = 'ğŸ¥‡';
            else if (totalScore >= 1500) medal.innerText = 'ğŸ¥ˆ';
            else if (totalScore >= 500) medal.innerText = 'ğŸ¥‰';
            else medal.innerText = '';
        };

        window.updateGarden = () => {
            const bed = document.getElementById('flower-bed');
            if(!bed) return;
            bed.innerHTML = '';
            const count = Math.min(12, Math.floor(totalScore / 100) + 1);
            for (let i = 0; i < count; i++) {
                const flower = document.createElement('div');
                flower.className = 'planted-flower';
                flower.innerText = flowerDb[i % flowerDb.length].icon;
                flower.style.fontSize = (Math.random() * 20 + 45) + 'px';
                flower.style.left = (Math.random() * 80 + 10) + '%';
                flower.style.bottom = (Math.random() * 30 + 10) + 'px';
                flower.style.animationDelay = (Math.random() * 2) + 's';
                bed.appendChild(flower);
            }
        };

        function startCommunityListener() {
            if(!window.db || !currentUser) return;
            if(communityUnsubscribe) communityUnsubscribe();

            const postsRef = collection(window.db, 'artifacts', window.appId, 'public', 'data', 'posts');
            
            communityUnsubscribe = onSnapshot(postsRef, (snapshot) => {
                const container = document.getElementById('community-container');
                if(!container) return;
                
                const posts = [];
                snapshot.forEach(doc => posts.push({id: doc.id, ...doc.data()}));
                posts.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                if(posts.length === 0) {
                    container.innerHTML = '<p class="text-center mt-20 text-gray-400 font-bold">ì²« ì†Œì‹ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</p>';
                    return;
                }

                container.innerHTML = '';
                posts.forEach(post => {
                    const item = document.createElement('div');
                    item.className = 'community-item';
                    item.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-sm font-bold text-orange-500">ğŸŒ¸ ë™ë„¤ ì£¼ë¯¼</span>
                            <span class="text-xs text-gray-400">${post.date || ''}</span>
                        </div>
                        <p class="text-xl font-bold text-gray-700 mb-3 break-keep">${post.content}</p>
                        <div class="flex justify-end">
                            <button onclick="window.likePost('${post.id}', ${post.likes || 0})" class="bg-pink-50 text-pink-500 px-4 py-1 rounded-full text-sm font-bold border border-pink-100">
                                â¤ï¸ ì˜ˆë»ìš” ${post.likes || 0}
                            </button>
                        </div>
                    `;
                    container.appendChild(item);
                });
            }, (err) => {
                console.error("ì»¤ë®¤ë‹ˆí‹° ì—°ê²° ì˜¤ë¥˜:", err);
            });
        }

        window.likePost = async (postId, currentLikes) => {
            if(!currentUser || !window.db) return;
            const postRef = doc(window.db, 'artifacts', window.appId, 'public', 'data', 'posts', postId);
            await updateDoc(postRef, { likes: currentLikes + 1 });
            confetti({ particleCount: 30, spread: 50 });
        };

        window.saveDiary = async (isPublic) => {
            const input = document.getElementById('diary-input');
            const content = input.value.trim();
            if (!content || !currentUser) return;

            const newEntry = {
                date: new Date().toLocaleDateString(),
                content: content,
                score: (currentStage * 20),
                timestamp: serverTimestamp(),
                likes: 0,
                userId: currentUser.uid
            };

            diaries.unshift(newEntry);
            localStorage.setItem('diaries', JSON.stringify(diaries));
            totalScore += 50;
            localStorage.setItem('totalScore', totalScore);

            if (isPublic && window.db) {
                try {
                    await addDoc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'posts'), newEntry);
                } catch (e) { console.error("ì €ì¥ ì‹¤íŒ¨:", e); }
            }

            input.value = '';
            window.closeModal('diary-modal');
            window.updateUI();
            window.updateGarden();
            window.goHome();
            confetti({ particleCount: 100 });
        };

        window.startGame = () => { currentStage = 1; hideAllScreens(); document.getElementById('game-screen').classList.remove('hidden'); initGame(); };
        window.goHome = () => { hideAllScreens(); document.getElementById('home-screen').classList.remove('hidden'); window.updateUI(); window.updateGarden(); };
        window.showCommunity = () => { hideAllScreens(); document.getElementById('community-screen').classList.remove('hidden'); };
        window.showLogs = () => {
            hideAllScreens();
            document.getElementById('logs-screen').classList.remove('hidden');
            const container = document.getElementById('logs-container');
            container.innerHTML = diaries.length === 0 ? '<p class="text-center mt-20 font-bold text-gray-400">ì¼ì§€ë¥¼ ê¸°ë¡í•´ ë³´ì„¸ìš”!</p>' : '';
            diaries.forEach(entry => {
                const item = document.createElement('div');
                item.className = 'log-item';
                item.innerHTML = `<div class="flex justify-between text-xs font-bold text-gray-400 mb-1"><span>${entry.date}</span><span class="text-green-600">+${entry.score}ì </span></div><p class="text-xl font-bold text-gray-700">${entry.content}</p>`;
                container.appendChild(item);
            });
        };

        window.closeModal = (id) => { document.getElementById(id).style.display = 'none'; };
        window.openDiaryModal = () => { document.getElementById('result-modal').style.display = 'none'; document.getElementById('diary-modal').style.display = 'flex'; };
        
        window.saveGardenImage = async () => {
            try {
                const captureArea = document.getElementById('capture-area');
                const canvas = await html2canvas(captureArea, { scale: 2 });
                const link = document.createElement('a');
                link.href = canvas.toDataURL("image/png");
                link.download = `ë‚˜ì˜ì •ì›.png`;
                link.click();
            } catch (e) { console.error(e); }
        };

        function hideAllScreens() {
            ['home-screen', 'game-screen', 'logs-screen', 'community-screen'].forEach(id => document.getElementById(id).classList.add('hidden'));
        }

        function initGame() {
            const grid = document.getElementById('game-grid');
            grid.innerHTML = '';
            matchedCount = 0; selectedCards = [];
            document.getElementById('stage-display').innerText = `${currentStage}ë‹¨ê³„`;
            
            let config = (currentStage === 1) ? {row:2, col:2, cls:'grid-cols-2'} : (currentStage === 2) ? {row:3, col:2, cls:'grid-cols-2'} : {row:4, col:3, cls:'grid-cols-3'};
            totalCardsInStage = config.row * config.col;
            grid.className = `grid gap-4 w-full px-4 justify-center ${config.cls}`;
            
            const stageFlowers = flowerDb.slice(0, totalCardsInStage/2).map(f => f.icon);
            let cardValues = [...stageFlowers, ...stageFlowers].sort(() => Math.random() - 0.5);
            
            cardValues.forEach((val, i) => {
                const card = document.createElement('div');
                card.className = 'flower-card';
                card.innerHTML = `<div class="card-inner" id="card-${i}"><span class="pointer-events-none">${val}</span></div>`;
                card.onclick = () => {
                    const el = document.getElementById(`card-${i}`);
                    if (el.classList.contains('matched') || selectedCards.some(c => c.i === i)) return;
                    el.classList.add('selected');
                    selectedCards.push({i, val});
                    if (selectedCards.length === 2) setTimeout(checkMatch, 500);
                };
                grid.appendChild(card);
            });
        }

        function checkMatch() {
            const [c1, c2] = selectedCards;
            const el1 = document.getElementById(`card-${c1.i}`), el2 = document.getElementById(`card-${c2.i}`);
            if (c1.val === c2.val) {
                el1.classList.add('matched'); el2.classList.add('matched');
                matchedCount += 2;
                if (matchedCount === totalCardsInStage) {
                    confetti({ particleCount: 150 });
                    setTimeout(() => document.getElementById('result-modal').style.display = 'flex', 800);
                }
            } else { el1.classList.remove('selected'); el2.classList.remove('selected'); }
            selectedCards = [];
        }

        window.nextStage = () => { currentStage++; document.getElementById('result-modal').style.display = 'none'; initGame(); };

        window.onload = init;
    </script>
</body>
</html>